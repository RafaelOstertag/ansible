---
- name: Debian | remove cfengine3
  apt: state=absent purge=true name=cfengine3

- name: Debian | install apt-transport-https
  apt: state=present name=apt-transport-https

- name: Debian | install apt key
  apt_key: state=present url=https://cfengine-package-repos.s3.amazonaws.com/pub/gpg.key

- name: Debian | add repository
  apt_repository: repo="deb https://cfengine-package-repos.s3.amazonaws.com/pub/apt/packages stable main" update_cache=yes state=present
  
- name: Debian | add cfengine community
  apt: pkg=cfengine-community state=present update_cache=yes

- name: Debian | install defaults file
  copy: dest=/etc/default/cfengine3 force=yes src=debian.cfengine3.default

- name: Debian | create cfengine keys
  command: /usr/local/sbin/cf-key creates=/var/cfengine/ppkeys/localhost.pub

- name: Debian | Copy update.cf
  copy: src=cfengine/update.cf dest=/var/cfengine/inputs/update.cf force=yes

- name: Debian | Copy failsafe.cf
  copy: src=cfengine/failsafe.cf dest=/var/cfengine/inputs/failsafe.cf force=yes

- name: Debian | bootstrap cfengine
  command: /usr/local/sbin/cf-agent -f failsafe.cf

- name: Debian | restart cfexecd
  service: name=cfengine3 state=restarted
