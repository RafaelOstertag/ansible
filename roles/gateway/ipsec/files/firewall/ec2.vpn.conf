# Maintained by Ansible

pass on $ext_if proto $ipsecproto modulate state # ipsec

# Make sure the traffic does not leave the net unencrypted
block out log on $ext_if proto gre
block out log on $ext_if to $ec2_net

# Allow gizmo to send mail via ec2_smtp_1
pass out quick on $ec2_if proto tcp from $mailserver_int to $ec2_smtp_1 port 25

# Make IPSec (IKEv2) work
pass in quick on $ext_if proto udp from $ec2_initiator port 500 to port 500
pass in quick on $ext_if proto udp from $ec2_initiator port 4500 to port 4500

# Access to internal jenkins server
pass in quick on $ec2_if proto tcp from $ec2_web_1 to $jenkinsserver port 8180 modulate state
pass out quick on $int_if proto tcp from $ec2_web_1 to $jenkinsserver port 8180 modulate state

# Allow to send mail to gizmo
pass in quick on $ec2_if proto tcp from $ec2_hosts to $mailserver_int port { 25, 587 } modulate state
pass out quick on $int_if proto tcp from $ec2_hosts to $mailserver_int port { 25, 587 } modulate state

# Access to portscanner api proxy
pass in quick on $ec2_if proto tcp from $ec2_web_1 to $portscanner_api port 40002 modulate state
pass out quick on $int_if proto tcp from $ec2_web_1 to $portscanner_api port 40002 modulate state

# Access to backup server
pass in quick on $ec2_if proto tcp from $ec2_web_1 to $ec2_backup_server port 873 modulate state
pass out quick on $int_if proto tcp from $ec2_web_1 to $ec2_backup_server port 873 modulate state

# Access to imapd
pass in quick on $ec2_if proto tcp from $ec2_smtp_1 to $mailserver_int port 993 modulate state
pass out quick on $int_if proto tcp from $ec2_smtp_1 to $mailserver_int port 993 modulate state

# Nagios sendmail check. We cannot use the external IP address because the provider redirects
# that to it's own mailserver
pass out quick on $ec2_if proto tcp from $nagiosserver to $ec2_hosts port 25 modulate state

# Allow nagios to connect to nrpe
pass out quick on $ec2_if proto tcp from $nagiosserver to $ec2_hosts port 5666 modulate state

# Postgresql Server
pass out quick on $ec2_if proto tcp to $ec2_hosts port 5432 modulate state

# Allow ICMP
pass in quick on $ec2_if proto icmp from $ec2_net to $lan1 modulate state
pass out quick on $int_if proto icmp from $ec2_net to $lan1 modulate state
pass out quick on $ec2_if proto icmp from $lan1 to $ec2_net modulate state
