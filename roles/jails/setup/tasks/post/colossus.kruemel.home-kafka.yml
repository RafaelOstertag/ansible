---

- name: Mount jail /dev
  include_tasks: helper/mount-temp-dev.yml

- name: Install packages in {{ jail_name }} jail
  pkgng:
    name:
      - openjdk11
      # Bash is used for startup scripts
      - bash
    state: present
    chroot: "{{ jail_root_directory }}/{{ jail_name }}"

- name: Unmount jail /dev
  include_tasks: helper/umount-temp-dev.yml

- name: Link java binary
  file:
    state: link
    src: "/usr/local/openjdk11/bin/java"
    dest: "{{ jail_root_directory }}/{{ jail_name }}/usr/local/bin/java"
    # The absolute path is inside the jail, the module is not aware of that
    force: yes

- name: Create /usr/local/bin in jail
  file:
    path: "{{ jail_root_directory }}/{{ jail_name }}/usr/local/bin/"
    state: directory
    mode: 0755
    owner: root
    group: wheel

- name: Install kafka stop script in {{ jail_name }} jail
  copy:
    src: kafka/kafkastop.sh
    dest: "{{ jail_root_directory }}/{{ jail_name }}/usr/local/bin/kafkastop.sh"
    owner: root
    mode: 0755

- name: Create jail user
  include_tasks: helper/create-jail-user.yml
  vars:
    jail_user: "{{ jail_name }}"

- name: Create /var/log/kafka in jail
  file:
    path: "{{ jail_root_directory }}/{{ jail_name }}/var/log/kafka"
    state: directory
    mode: 0700
    owner: "5000"
    group: "5000"
