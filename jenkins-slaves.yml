---

- name: Jenkins Slaves
  hosts: jenkins_slaves
  user: root
  tasks:
    - name: Create slave user
      user:
        comment: Jenkins Slave User
        createhome: yes
        generate_ssh_key: yes
        name: jenkins
        state: present
        system: no
        home: /var/cache/jenkins-slave

    - name: Slurp user ssh public key
      slurp:
        src: /var/cache/jenkins-slave/.ssh/id_rsa.pub
      register: ssh_pub

    - name: Enable ssh login with key
      authorized_key:
        manage_dir: yes
        user: jenkins
        state: present
        key: "{{ ssh_pub['content'] | b64decode }}"

    - name: FreeBSD packages
      when: "ansible_distribution == 'FreeBSD'"
      pkgng:
        name:
          - autoconf
          - automake
          - cppunit
          # When building agentsmith web page
          - docbook-xsl
          - gettext
          - gettext-tools
          - git
          - gmake
          # When building agentsmith web page
          - hs-pandoc
          - libargon2
          - libtool
          - libxslt
          - openjdk11
          - openjdk8
          - pcre
          - pkgconf
          # Whe building yapet docs
          - ruby25-gems
          - tidy-html5
          # When building agentsmith web page
          - tidy4
          - w3m
        state: present

    - name: Linux packages
      when: "ansible_distribution == 'Debian'"
      apt:
        name:
          - autoconf
          - automake
          - autopoint
          - docbook-xsl
          - g++
          - gettext
          - git
          - libcppunit-dev
          - libpcre3-dev
          - libtool
          - openjdk-11-jdk
          - w3m
          - xsltproc
          - libargon2-0-dev
        state: present

    - name: OpenBSD packages
      when: "ansible_distribution == 'OpenBSD'"
      openbsd_pkg:
        name:
          - autoconf-2.69p2
          - automake-1.15.1
          - cppunit
          - docbook-xsl
          - gettext
          - gettext-tools
          - git
          - gmake
          - jdk-1.8.0.202v0
          - jdk-11.0.2.9.3p0v0
          - libtool
          - libxslt
          - pcre
          - w3m-0.5.3p7
          - argon2
        state: present

    - name: NetBSD packages
      when: "ansible_distribution == 'NetBSD'"
      pkgin:
        name:
          - autoconf
          - automake
          - cppunit
          - docbook-xsl
          - gettext
          - gettext-tools
          # Has currently broken dependencies
          #- git
          - gmake
          - libtool
          - libxslt
          - openjdk8
          - pcre
          - w3m
          - argon2
          - mozilla-rootcerts-openssl
          - pkgconf
        state: present

    - name: OpenBSD fixes
      when: "ansible_distribution == 'OpenBSD'"
      block:
        - name: Fix pkg config file
          lineinfile:
            path: /usr/local/lib/pkgconfig/libargon2.pc
            regexp: "^Libs:\\s+"
            line: "Libs: -L${libdir} -largon2"
            state: present

