---

- name: FreeBSD Servers
  hosts: freebsd-servers
  force_handlers: true
  user: root
  tasks:
    - import_role:
        name: common/dotnetrc
    - import_role:
        name: common/etcfiles
    - import_role:
        name: common/motd
    - import_role:
        name: common/mailmon
    # Keep this on top. Other roles might use pkgng
    - import_role:
        name: freebsd/disable-default-pkgrepo
    # Keep this on top. Other roles might use pkgng
    - import_role:
        name: freebsd/guengel-pkgrepo
      tags:
        - repo
    - import_role:
        name: freebsd/freebsd-update-cron
    - import_role:
        name: freebsd/resolvconf
    - import_role:
        name: freebsd/openldap-client-conf
    - import_role:
        name: freebsd/prefer-ipv6
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_static_routes"
        value: "dmz6 web6"
      when: "'freebsd-servers-dmz' not in group_names"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_dmz6"
        value: "-net fd3e:be3e:ec34:1:: -prefixlen 64 fd3e:be3e:ec34::2"
      when: "'freebsd-servers-dmz' not in group_names"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_web6"
        value: "-net fd3e:be3e:ec34:2:: -prefixlen 64 fd3e:be3e:ec34::2"
      when: "'freebsd-servers-dmz' not in group_names"
      
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_static_routes"
        value: "lan6"
      when: "'freebsd-servers-dmz' in group_names and not jail_webserver"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_lan6"
        value: "-net fd3e:be3e:ec34:0:: -prefixlen 64 fd3e:be3e:ec34:1::1"
      when: "'freebsd-servers-dmz' in group_names and not jail_webserver"
  
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_static_routes"
        value: "lan6 web1 lo2 lo3 lo4 lo5 lo6 lo7 lo8 lo9 lo10 lo11 lo12"
      when: "'freebsd-servers-dmz' in group_names and jail_webserver"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_lan6"
        value: "-net fd3e:be3e:ec34:0:: -prefixlen 64 fd3e:be3e:ec34:1::1 -fib 0"
      when: "'freebsd-servers-dmz' in group_names and jail_webserver"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_web1"
        value: "-net fd3e:be3e:ec34:0:: -prefixlen 64 fd3e:be3e:ec34:2::1 -fib 1"
      when: "'freebsd-servers-dmz' in group_names and jail_webserver"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_lo2"
        value: "-host fd3e:be3e:ec34:ffff::2 -prefixlen 128 fd3e:be3e:ec34:ffff::2 -fib 1 -iface"
      when: "'freebsd-servers-dmz' in group_names and jail_webserver"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_lo3"
        value: "-host fd3e:be3e:ec34:ffff::3 -prefixlen 128 fd3e:be3e:ec34:ffff::3 -fib 1 -iface"
      when: "'freebsd-servers-dmz' in group_names and jail_webserver"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_lo4"
        value: "-host fd3e:be3e:ec34:ffff::4 -prefixlen 128 fd3e:be3e:ec34:ffff::4 -fib 1 -iface"
      when: "'freebsd-servers-dmz' in group_names and jail_webserver"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_lo5"
        value: "-host fd3e:be3e:ec34:ffff::5 -prefixlen 128 fd3e:be3e:ec34:ffff::5 -fib 1 -iface"
      when: "'freebsd-servers-dmz' in group_names and jail_webserver"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_lo6"
        value: "-host fd3e:be3e:ec34:ffff::6 -prefixlen 128 fd3e:be3e:ec34:ffff::6 -fib 1 -iface"
      when: "'freebsd-servers-dmz' in group_names and jail_webserver"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_lo7"
        value: "-host fd3e:be3e:ec34:ffff::7 -prefixlen 128 fd3e:be3e:ec34:ffff::7 -fib 1 -iface"
      when: "'freebsd-servers-dmz' in group_names and jail_webserver"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_lo8"
        value: "-host fd3e:be3e:ec34:ffff::8 -prefixlen 128 fd3e:be3e:ec34:ffff::8 -fib 1 -iface"
      when: "'freebsd-servers-dmz' in group_names and jail_webserver"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_lo9"
        value: "-host fd3e:be3e:ec34:ffff::9 -prefixlen 128 fd3e:be3e:ec34:ffff::9 -fib 1 -iface"
      when: "'freebsd-servers-dmz' in group_names and jail_webserver"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_lo10"
        value: "-host fd3e:be3e:ec34:ffff::10 -prefixlen 128 fd3e:be3e:ec34:ffff::10 -fib 1 -iface"
      when: "'freebsd-servers-dmz' in group_names and jail_webserver"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_lo11"
        value: "-host fd3e:be3e:ec34:ffff::11 -prefixlen 128 fd3e:be3e:ec34:ffff::11 -fib 1 -iface"
      when: "'freebsd-servers-dmz' in group_names and jail_webserver"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ipv6_route_lo12"
        value: "-host fd3e:be3e:ec34:ffff::12 -prefixlen 128 fd3e:be3e:ec34:ffff::12 -fib 1 -iface"
      when: "'freebsd-servers-dmz' in group_names and jail_webserver"

      
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "snmpd_enable"
        value: "NO"
        
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "nrpe3_enable"
        value: "YES"
    - name: Remove old nrpe2_enable
      lineinfile:
        path: /etc/rc.conf
        regexp: "^nrpe2_enable="
        state: absent
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "clear_tmp_enable"
        value: "YES"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "accounting_enable"
        value: "YES"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "sshd_enable"
        value: "YES"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "gssd_enable"
        value: "NO"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "gssd_flags"
        value: "-h"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "ip6addrctl_enable"
        value: "YES"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "syslogd_flags"
        value: "-ss"
      # the jail server requires remote logging
      when: 'not jail_webserver'
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "tcp_extensions"
        value: "YES"
    - import_role:
        name: freebsd/rcconf
      vars:
        rcvar: "sendmail_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_status_disks_enable"
        value: "YES"
      when: "not jail"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_status_disks_df_flags"
        value: "-h"
      when: "not jail"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_status_mailq_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_status_ntpd_enable"
        value: "YES"
      when: "not jail"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "weekly_noid_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_accounting_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "monthly_accounting_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_status_security_portaudit_enable"
        value: "NO"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_pkgaudit_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_pkgaudit_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_status_include_submit_mailq"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_chkmounts_enable"
        value: "YES"
      when: "not jail"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_chkmounts_period"
        value: "daily"
      when: "not jail"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_chkuid0_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_chkuid0_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_logincheck_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_logincheck_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_kernelmsg_enable"
        value: "YES"
      when: "not jail"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_kernelmsg_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_loginfail_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_loginfail_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_tcpwrap_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_tcpwrap_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_chkportsum_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_chkportsum_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_neggrpperm_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_neggrpperm_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_passwdless_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_passwdless_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_status_network_enable"
        value: "YES"
    - import_role:
        name: freebsd/sysctl
      vars:
        varname: "security.bsd.see_other_uids"
        value: "0"
      when: "not jail"
    - import_role:
        name: freebsd/sysctl
      vars:
        varname: "kern.randompid"
        value: "100"
      when: "not jail"
    - import_role:
        name: freebsd/aide
    - import_role:
        name: freebsd/amanda-enable
      tags:
        - amanda
    - import_role:
        name: common/amanda-client
      tags:
        - amanda
    - import_role:
        name: freebsd/amanda-hosts
      tags:
        - amanda
    - import_role:
        name: common/crontab
    - import_role:
        name: freebsd/kerberos
      tags:
        - kerberos
    - import_role:
        name: freebsd/openldap-server-schemas
    - import_role:
        name: freebsd/openldap-server-ssl
    - import_role:
        name: freebsd/logwatch
    - import_role:
        name: freebsd/nagios-nrpe-config
    - import_role:
        name: freebsd/sudo
    - import_role:
        name: freebsd/ntp
      when: "not jail"
    - import_role:
        name: freebsd/mailserver
      when: 'not smart_host and not edge_mailserver'
    - import_role:
        name: freebsd/mailserver-smarthost
      when: "smart_host"
    - import_role:
        name: common/scripts
    - import_role:
        name: common/ssh-keys
      tags:
        ssh-keys
    - import_role:
        name: freebsd/root-ssh-config
    - import_role:
        name: freebsd/procfs
      when: "not jail"
    - import_role:
        name: freebsd/fdescfs
      when: "not jail"
    # This role is used to make some nagios plugins work, since it
    # also links python to /usr/bin
    - import_role:
        name: freebsd/install-python
    # Keep this role here, it allows the procfs and fdescfs to succeed.
    - import_role:
        name: freebsd/set-security-level
      vars:
        enable_secure_level: True
        secure_level: "1"
      when: "not jail"
    - import_role:
        name: freebsd/edge-mailserver
      when: 'edge_mailserver'
    - import_role:
        name: freebsd/zfs-scrub
      when: "enable_zfs_scrub"
    - import_role:
        name: common/agentsmith-certificate
      tags:
        - agentsmith
