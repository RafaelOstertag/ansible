---
- name: Jenkins Slaves
  hosts: jenkins_slaves
  user: root
  tasks:
    - name: Create slave user
      user:
        comment: Jenkins Slave User
        createhome: yes
        generate_ssh_key: yes
        name: jenkins
        state: present
        system: no
        home: /var/cache/jenkins-slave

    - name: Slurp user ssh public key
      slurp:
        src: /var/cache/jenkins-slave/.ssh/id_rsa.pub
      register: ssh_pub

    - name: Enable ssh login with key
      authorized_key:
        manage_dir: yes
        user: jenkins
        state: present
        key: "{{ ssh_pub['content'] | b64decode }}"

    - name: FreeBSD packages
      when: "ansible_distribution == 'FreeBSD'"
      pkgng:
        name:
          - autoconf
          - automake
          - cppunit
          # When building agentsmith web page
          - docbook-xsl
          - gettext
          - gettext-tools
          - git
          - gmake
          - gradle
          # When building agentsmith web page
          - hs-pandoc
          - libargon2
          - libtool
          - libxslt
          - node
          - npm
          - openjdk11
          - openjdk8
          - pcre
          - pkgconf
          # Whe building yapet docs
          - ruby26-gems
          - tidy-html5
          # When building agentsmith web page
          - tidy4
          - w3m
        state: present

    - name: Linux packages
      when: "ansible_distribution == 'Debian' and not ansible_machine == 'aarch64'"
      block:
        - name: Linux Packages non aarch64
          apt:
            name:
              - autoconf
              - automake
              - autopoint
              - docbook-xsl
              - g++
              - gettext
              - git
              - libargon2-0-dev
              - libcppunit-dev
              - libncurses-dev
              - libpcre3-dev
              - libtool
              - nodejs
              - npm
              - openjdk-11-jdk
              - w3m
              - xsltproc
              - xvfb
            state: present
        - import_role:
            name: raspberrypi/yellowfish-buildhost

    - name: Linux packages aarch64
      when: "ansible_distribution == 'Debian' and ansible_machine == 'aarch64'"
      apt:
        name:
          - openjdk-11-jdk
        state: present

    - name: OpenBSD packages
      when: "ansible_distribution == 'OpenBSD'"
      openbsd_pkg:
        name:
          - autoconf-2.69p2
          - automake-1.15.1
          - cppunit
          - docbook-xsl
          - gettext-runtime
          - gettext-tools
          - git
          - gmake
          - jdk-1.8.0.252.b09.1v0
          - jdk-11.0.7.10.2p0v0
          - libtool
          - libxslt
          - pcre
          - w3m-0.5.3p8
          - argon2
        state: present

    - name: OpenBSD fixes
      when: "ansible_distribution == 'OpenBSD'"
      block:
        - name: Fix pkg config file
          lineinfile:
            path: /usr/local/lib/pkgconfig/libargon2.pc
            regexp: "^Libs:\\s+"
            line: "Libs: -L${libdir} -largon2"
            state: present

    - name: Install guengel.ch certificate
      when: "ansible_distribution == 'FreeBSD'"
      import_role:
        name: freebsd/javacerts
      tags:
        - javacerts

    - name: Install guengel.ch certificate
      when: "ansible_distribution == 'Debian'"
      import_role:
        name: linux/javacerts
      tags:
        - javacerts
