---

- name: FreeBSD Servers
  hosts: freebsd_servers
  force_handlers: true
  user: root
  tasks:
    - import_role:
        name: common/etcfiles
    - import_role:
        name: common/motd
    - import_role:
        name: common/ssh-keys
      tags:
        ssh-keys
    # Keep this on top. Other roles might use pkgng
    - import_role:
        name: freebsd/disable-default-pkgrepo
    # Keep this on top. Other roles might use pkgng
    - import_role:
        name: freebsd/guengel-pkgrepo
      tags:
        - repo
    - import_role:
        name: freebsd/freebsd-update-cron
    - import_role:
        name: freebsd/resolvconf
    - import_role:
        name: freebsd/openldap-client-conf
    - import_role:
        name: freebsd/prefer-ipv6
    - import_role:
        name: freebsd/reusable/rcconf
      vars:
        rcvar: "ipv6_static_routes"
        value: "dmz6"
      when: "'freebsd_servers_dmz' not in group_names"
    - import_role:
        name: freebsd/reusable/rcconf
      vars:
        rcvar: "ipv6_route_dmz6"
        value: "-net fd3e:be3e:ec34:1:: -prefixlen 64 fd3e:be3e:ec34::2"
      when: "'freebsd_servers_dmz' not in group_names"
      
    - import_role:
        name: freebsd/reusable/rcconf
      vars:
        rcvar: "ipv6_static_routes"
        value: "lan6"
      when: "'freebsd_servers_dmz' in group_names"
    - import_role:
        name: freebsd/reusable/rcconf
      vars:
        rcvar: "ipv6_route_lan6"
        value: "-net fd3e:be3e:ec34:0:: -prefixlen 64 fd3e:be3e:ec34:1::1"
      when: "'freebsd_servers_dmz' in group_names"
  
    - import_role:
        name: freebsd/reusable/rcconf
      vars:
        rcvar: "clear_tmp_enable"
        value: "YES"
    - import_role:
        name: freebsd/reusable/rcconf
      vars:
        rcvar: "accounting_enable"
        value: "YES"
    - import_role:
        name: freebsd/reusable/rcconf
      vars:
        rcvar: "sshd_enable"
        value: "YES"

    - import_role:
        name: freebsd/reusable/rcconf
      vars:
        rcvar: "ip6addrctl_enable"
        value: "YES"
    - import_role:
        name: freebsd/reusable/rcconf
      vars:
        rcvar: "syslogd_flags"
        value: "-ss"
    - import_role:
        name: freebsd/reusable/rcconf
      vars:
        rcvar: "tcp_extensions"
        value: "YES"
    - import_role:
        name: freebsd/reusable/rcconf
      vars:
        rcvar: "sendmail_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_status_disks_enable"
        value: "YES"
      when: "not jail"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_status_disks_df_flags"
        value: "-h"
      when: "not jail"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_status_mailq_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_status_ntpd_enable"
        value: "YES"
      when: "not jail"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "weekly_noid_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_accounting_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "monthly_accounting_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_status_security_portaudit_enable"
        value: "NO"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_pkgaudit_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_pkgaudit_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_status_include_submit_mailq"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_chkmounts_enable"
        value: "YES"
      when: "not jail"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_chkmounts_period"
        value: "daily"
      when: "not jail"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_chkuid0_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_chkuid0_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_logincheck_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_logincheck_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_kernelmsg_enable"
        value: "YES"
      when: "not jail"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_kernelmsg_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_loginfail_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_loginfail_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_tcpwrap_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_tcpwrap_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_chkportsum_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_chkportsum_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_neggrpperm_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_neggrpperm_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_passwdless_enable"
        value: "YES"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "security_status_passwdless_period"
        value: "daily"
    - import_role:
        name: freebsd/periodic
      vars:
        varname: "daily_status_network_enable"
        value: "YES"
    - import_role:
        name: freebsd/sysctl-defaults
      when: "not jail"
      tags:
        - sysctl
    - import_role:
        name: freebsd/amanda-enable
      tags:
        - amanda
    - import_role:
        name: common/amanda-client
      tags:
        - amanda
    - import_role:
        name: freebsd/amanda-hosts
      tags:
        - amanda
    - import_role:
        name: freebsd/kerberos
      tags:
        - kerberos
    - import_role:
        name: freebsd/nagios-nrpe-config
      tags:
        - nagios
    - import_role:
        name: freebsd/sudo
      tags:
        - sudo
    - import_role:
        name: freebsd/ntp
      when: "not jail"

    - import_role:
        name: freebsd/mailserver
      when: 'not smart_host'
      tags:
        - mailserver
    - import_role:
        name: freebsd/mailserver-smarthost
      when: "smart_host"
      tags:
        - mailserver

    - import_role:
        name: freebsd/root-ssh-config
    - import_role:
        name: freebsd/procfs
      when: "not jail"
    - import_role:
        name: freebsd/fdescfs
      when: "not jail"
    # This role is used to make some nagios plugins work, since it
    # also links python to /usr/bin
    - import_role:
        name: freebsd/install-python
    - import_role:
        name: freebsd/zfs-scrub
      when: "enable_zfs_scrub"
    - import_role:
        name: common/agentsmith-certificate
      tags:
        - agentsmith
    - import_role:
        name: freebsd/javacerts
      tags:
        - javacerts

    - import_role:
        name: freebsd/syslogd
      tags:
        - syslog

    - import_role:
        name: common/add-ec2-hosts
      tags:
        - ec2
