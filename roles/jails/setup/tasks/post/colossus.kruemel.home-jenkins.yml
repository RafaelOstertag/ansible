---

- name: Mount jail /dev
  include_tasks: helper/mount-temp-dev.yml

- name: Install packages in {{ jail_name }} jail
  pkgng:
    name:
      - jenkins-lts
      - openjdk11
      - git
    state: present
    chroot: "{{ jail_root_directory }}/{{ jail_name }}"

- name: Unmount jail /dev
  include_tasks: helper/umount-temp-dev.yml

# That's awkward: We need keytool to be installed on the jail host, since java_cert
# is not able to run in the jail...
- name: Install java on host
  pkgng:
    name:
      - openjdk8
    state: present

- name: Install Guengel CA in keystore java 8
  java_cert:
    cert_alias: guengel.ch
    cert_path: /etc/ssl/guengel.ch.pem
    keystore_create: false
    keystore_pass: changeit
    keystore_path: "{{ jail_root_directory }}/{{ jail_name }}/usr/local/openjdk8/jre/lib/security/cacerts"
    state: present

- name: Install Guengel CA in keystore java 11
  java_cert:
    cert_alias: guengel.ch
    cert_path: /etc/ssl/guengel.ch.pem
    keystore_create: false
    keystore_pass: changeit
    keystore_path: "{{ jail_root_directory }}/{{ jail_name }}/usr/local/openjdk11/lib/security/cacerts"
    state: present

- name: Enable jenkins in {{ jail_name }} jail
  lineinfile:
    path: "{{ jail_root_directory }}/{{ jail_name }}/etc/rc.conf"
    create: yes
    state: present
    regexp: ^jenkins_enable=.*
    line: jenkins_enable="YES"

- name: Use java 11 for jenkins in {{ jail_name }} jail
  lineinfile:
    path: "{{ jail_root_directory }}/{{ jail_name }}/etc/rc.conf"
    create: yes
    state: present
    regexp: ^jenkins_java_home=.*
    line: jenkins_java_home="/usr/local/openjdk11"

- name: Limit heap space for jenkins in {{ jail_name }} jail
  lineinfile:
    path: "{{ jail_root_directory }}/{{ jail_name }}/etc/rc.conf"
    create: yes
    state: present
    regexp: ^jenkins_java_opts=.*
    line: jenkins_java_opts="-Xmx8G"

- name: Set arguments for jenkins in {{ jail_name }} jail
  lineinfile:
    path: "{{ jail_root_directory }}/{{ jail_name }}/etc/rc.conf"
    create: yes
    state: present
    regexp: ^jenkins_args=.*
    line: jenkins_args="--httpPort=8180 --prefix=/jenkins"

