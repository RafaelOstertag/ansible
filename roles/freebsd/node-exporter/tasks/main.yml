---

- name: Install node exporter
  pkgng:
    name:
      - node_exporter
      # Used by smartmon.sh
      - bash
    state: present

- name: Is ZFS enabled
  stat:
    path: /zroot
  register: zfs

- name: Enable node exporter
  template:
    src: rc.conf.d/node_exporter
    dest: /usr/local/etc/rc.conf.d
    mode: "0644"
    owner: root
    group: wheel
  notify:
    - Restart FreeBSD node_exporter

- name: Start node exporter
  service:
    name: node_exporter
    state: started

- name: Install smartmon script
  copy:
    src: smartmon.sh
    dest: /usr/local/sbin/smartmon.sh
    mode: "0755"
    owner: root
    group: wheel

- name: Setup cronjob for smartmon.sh script
  cron:
    name: Node exporter smartmon
    state: present
    minute: "*/1"
    user: root
    job: "mkdir -p /var/cache/node_exporter && /usr/local/sbin/smartmon.sh > /var/cache/node_exporter/smartmon.new && mv /var/cache/node_exporter/smartmon.new /var/cache/node_exporter/smartmon.prom"
