---

- name: FreeBSD Web Jail Server
  hosts: eventhorizon.dmz.kruemel.home
  force_handlers: true
  user: root
  tasks:
    - import_role:
        name: webserver/jailsetup
      tags:
        - jails
       
    - include_role:
        name: webserver/jail-installation
      vars:
        jail_name: "{{ item.name }}"
      with_items: "{{ web_jails }}"
      tags:
        - jails

    - import_role:
        name: webserver/nginx
      tags:
        - nginx
        - reverse-proxy

    - include_role:
        name: webserver/sendmail-setup
      vars:
        jail_name: "{{ item.name }}"
        jail_loIP: "{{ item.loIPv6 }}"
        # This is required when we have to launch temporary jails
        jail_IP: "{{ item.IPv6 }}"
      with_items: "{{ web_jails }}"
      tags:
        - sendmail

    - include_role:
        name: webserver/apache-installation
      vars:
        jail_name: "{{ item.name }}"
        jail_IP: "{{ item.IPv6 }}"
      with_items: "{{ web_jails }}"
      tags:
        - apache

    - include_role:
        name: webserver/apache-configuration
      vars:
        jail_name: "{{ item.name }}"
        jail_IP: "{{ item.IPv6 }}"
      with_items: "{{ web_jails }}"
      tags:
        - apache
