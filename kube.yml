---

- name: Setup kubes
  hosts: kube01:kube02:kube03:kube04
  user: rafael
  become: true
  become_method: sudo

  tasks:
    - name: Install prereqs
      apt:
        update_cache: yes
        name: apt-transport-https,ca-certificates,curl,gnupg2,software-properties-common,vim
        state: latest

    - name: Install docker keys
      apt_key:
        url: https://download.docker.com/linux/debian/gpg
        state: present

    - name: Add docker repo
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/debian stretch stable
        state: present

    - name: Install docker
      apt:
        name: docker-ce
        state: latest

    - name: Enable docker
      systemd:
        name: docker
        enabled: yes

    - name: Start docker
      systemd:
        name: docker
        state: started

    - name: Install docker daemon configuration
      copy:
        src: kube/daemon.json
        dest: /etc/docker/daemon.json
      register: daemonconfig

    - name: Conditionally restart docker daemon
      when: "daemonconfig.changed"
      systemd:
        name: docker
        state: restarted
        
    - name: Install kubernets keys
      apt_key:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        state: present

    - name: Add kubernets repo
      apt_repository:
        repo: deb http://apt.kubernetes.io/ kubernetes-xenial main
        state: present

    - name: Install kubernets packages
      apt:
        name: kubelet,kubeadm,kubectl
        state: latest

    - name: Set sysctl variables
      sysctl:
        name: net.bridge.bridge-nf-call-iptables
        value: 1
        reload: yes
        state: present
        
    - name: Install nfs-common
      apt:
        name=nfs-common
        state=present

    - name: Create nfs user
      user:
        createhome: no
        group: nogroup
        home: /nonexistent
        name: nfs-kube
        shell: /usr/sbin/nologin
        state: present
        system: yes
        uid: 116
        
