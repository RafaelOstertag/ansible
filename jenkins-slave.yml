---

- name: Jenkins Slaves
  hosts: jenkins_slaves
  user: root
  tasks:
    - name: Create slave user
      user:
        comment: Jenkins Slave User
        createhome: yes
        generate_ssh_key: yes
        name: jenkins
        state: present
        system: no
        home: /var/cache/jenkins-slave

    - name: Slurp user ssh public key
      slurp:
        src: /var/cache/jenkins-slave/.ssh/id_rsa.pub
      register: ssh_pub
      
    - name: Enable ssh login with key
      authorized_key:
        manage_dir: yes
        user: jenkins
        state: present
        key: "{{ ssh_pub['content'] | b64decode }}"

    - name: FreeBSD packages
      when: "ansible_distribution == 'FreeBSD'"
      pkgng:
        name:
          - autoconf
          - automake
          - cppunit
          - docbook-xsl
          - gettext
          - gettext-tools
          - git
          - gmake
          - libtool
          - libxslt
          - openjdk8
          - openjdk11
          - pcre
          - pkgconf
          - w3m
          - libargon2
        state: present

    - name: Linux packages
      when: "ansible_distribution == 'Debian'"
      apt:
        name:
          - autoconf
          - automake
          - autopoint
          - docbook-xsl
          - g++
          - gettext
          - git
          - libcppunit-dev
          - libpcre3-dev
          - libtool
          - openjdk-11-jdk
          - w3m
          - xsltproc
          - libargon2-0-dev
        state: present

    - name: OpenBSD packages
      when: "ansible_distribution == 'OpenBSD'"
      openbsd_pkg:
        name:
          - autoconf-2.69p2
          - automake-1.15.1
          - cppunit
          - docbook-xsl
          - gettext
          - gettext-tools
          - git
          - gmake
          - jdk
          - libtool
          - libxslt
          - pcre
          - w3m-0.5.3p7
          - argon2
        state: present

    - name: NetBSD packages
      when: "ansible_distribution == 'NetBSD'"
      pkgin:
        update_cache: yes
        clean: yes
        name:
          - autoconf
          - automake
          - cppunit
          - docbook-xsl
          - gettext
          - gettext-tools
          - git
          - gmake
          - libtool
          - libxslt
          - openjdk8
          - pcre
          - w3m
          - argon2
        state: present
