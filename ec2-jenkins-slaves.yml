---

- name: EC2 FJenkins Slaves
  hosts: ec2_jenkins_slaves

  vars:
    ssh_keys_present:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDpk2bfcFx9NWiwIlqdDt1HlBnV52X2vV8rUqawgox/teRNfQPbZDRSU8o3JxmgVcnpt5JwY9rWiXLVMWrvwo7ryQSkvtschxwjCBDvq0FrF6Ck5qDO/hhnEIIo/kBVZdjuAqG7J6epw9o5xvNGG51CmMi7dH0ZINCNtPVhHLJjDW3wwq+GQbvwFX+h2JeqiioREDX/uN+kdVcAWcnHZiIYR91iTQPJTz1tkXPARxivXL/9zXugritaukbZe/JsQQmfs9T5G8TInQFoR06cEAc03OVGign4xNR7IbkSrZ6xPSzb5iwzdlEXAK+3NRo3vlmCBrJolXa6t9t6UIpDk/Rb rafi@starchild.kruemel.home
    jenkins_key: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCgmZu2b6zx5OlejKbVTgnldQ+ZAbtC/Ur+qAHX8hOXzsjedEoDrRBBTfgxX+j2gP2AvIdYIAPK42K7Wf2GXRckVCJw1CGeGm8IMseEJkr4zK4IrgmNmbERptA8iTcHyS5gL1BJNdFBpaFJcXBMvKRj4t8GukHJKstFDmFoxmUzoMCnVD2JItW1XieSxTbsaHr0bEh3ZRDtURpogYZm28HSVfgmS1v8XNA10hJ8SJ0yIvYAeqxHCmMxXMBx+4BBDbbkPimfEe4Y+X57m14VbPTAi5aJep3r1gGYe0O2zlsJU6J902h/FO6j/lbnop4XjP/ukjnj0FvMLe4FOAaVaJKb6Y/plq8/sGxFYWiMKLv+50x7tThcqxeaejTZYT1LE6EzVxN5QNr91j/WbpR8ibw6/ap8d3pMdf8drtS6Np7PsDd6rLtBgKtstORFaVGfXUw932RfEa6vwAAt48KldNemVE7hg1r7evhV2roMk53pOxR0p9W+IkSDQFVrY9NEQgvCqZAHSTjmAdUGvMieUj0rHAh7nfF+vzJmiRJOnDcZngh1a6gXDabioNyi+YJSJ049Mc+Xc9EHWkxi/aiK0jYWSUN49CHVgaZGEanpmmBVd0osBce7SU2muxxCfdKQ7yaKJF0s7/t9udj5Zgn5tZfdqhgxvHrv7ZmxctBFeIQcWQ== jenkins@jenkins

  tasks:
    - import_role:
        name: ec2/common/ssh-keys
      tags:
        - common
        - ssh

    - name: Install FreeBSD software
      when: "ansible_distribution == 'FreeBSD'"
      pkgng:
        name:
          - autoconf
          - automake
          - cppunit
          - curl
          - docbook-xsl
          - gettext
          - gettext-tools
          - git
          - gmake
          - go
          - hs-pandoc
          - libargon2
          - libtool
          - libxslt
          - node
          - npm
          - openjdk11
          - openjdk12
          - openjdk8
          - pcre
          - pkgconf
          - ruby25-gems
          - tidy-html5
          - tidy4
          - w3m
        state: present

    - name: Install Debian software
      when: "ansible_distribution == 'Debian'"
      apt:
        name:
          - autoconf
          - automake
          - autopoint
          - docbook-xsl
          - g++
          - gettext
          - git
          - libargon2-0-dev
          - libcppunit-dev
          - libncursesw5-dev
          - libpcre3-dev
          - libssl-dev
          - libtool
          - openjdk-8-jdk
          - w3m
          - xsltproc
        state: present


    - name: Create slave user
      user:
        comment: Jenkins Slave User
        createhome: yes
        generate_ssh_key: no
        name: jenkins
        state: present
        system: no
        home: /var/cache/jenkins-slave

    - name: Allow jenkins to login to jenkins user
      authorized_key:
        user: jenkins
        exclusive: yes
        key: "{{ jenkins_key }}"
        manage_dir: yes
        state: present

    # Leave this here, so it will pick up when we change the hostname
    - import_role:
        name: common/motd
      tags:
        - common

