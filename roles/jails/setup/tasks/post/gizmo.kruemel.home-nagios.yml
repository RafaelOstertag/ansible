---

- name: Install nagios in {{ jail_name }} jail
  pkgng:
    name: "{{ pkg_name }}"
    state: present
    chroot: "{{jail_root_directory}}/{{ jail_name }}"
  loop:
    - nagios4
    - nagios-check_postgres
    # This is required so that we have check_nrpe3
    - nrpe3
  loop_control:
    loop_var: pkg_name

- name: Enable nagios in {{ jail_name }} jail
  lineinfile:
    path: "{{jail_root_directory}}/{{ jail_name }}/etc/rc.conf"
    create: yes
    state: present
    regexp: ^nagios_enable=.*
    line: nagios_enable="YES"

# This is required so that we can use a webserver outside of the jail
- name: Create symbolic link to jail's /var/spool/nagios
  file:
    src: "{{jail_root_directory}}/{{ jail_name }}/var/spool/nagios"
    dest: /var/spool/nagios
    state: link

# This is required so that we can use a webserver outside of the jail
- name: Create symbolic link to jail's /usr/local/etc/nagios
  file:
    src: "{{jail_root_directory}}/{{ jail_name }}/usr/local/etc/nagios"
    dest: /usr/local/etc/nagios
    state: link

- name: Set domain name when sending mails
  lineinfile:
    state: present
    path: "{{jail_root_directory}}/{{ jail_name }}/etc/mail/submit.cf"
    regexp: "^Dj"
    line: "Djkruemel.home"

- name: Install plugins required by nagios
  copy:
    src: "nagios/plugins/{{ plugin }}"
    dest: "{{jail_root_directory}}/{{ jail_name }}/usr/local/libexec/nagios/{{ plugin }}"
    mode: 0755
    owner: root
    group: nagios
  loop:
    - check_external_ip
  loop_control:
    loop_var: plugin
