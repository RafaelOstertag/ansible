---

- name: FreeBSD Servers
  hosts: freebsd-servers
  force_handlers: true
  user: root
  tasks:
    - include_role:
        name: common/dotnetrc
    - include_role:
        name: common/etcfiles
    - include_role:
        name: common/motd
    - include_role:
        name: common/mailmon
    # Keep this on top. Other roles might use pkgng
    - include_role:
        name: freebsd/disable-default-pkgrepo
    # Keep this on top. Other roles might use pkgng
    - include_role:
        name: freebsd/guengel-pkgrepo
      tags:
        - repo
    - include_role:
        name: freebsd/resolvconf
    - include_role:
        name: freebsd/openldap-client-conf
    - include_role:
        name: freebsd/prefer-ipv6
    - include_role:
        name: freebsd/rcconf
      vars:
        name: "ipv6_static_routes"
        value: "dmz6"
      when: "'freebsd-servers-dmz' not in group_names"
    - include_role:
        name: freebsd/rcconf
      vars:
        name: "ipv6_route_dmz6"
        value: "-net fd3e:be3e:ec34:1:: -prefixlen 64 fd3e:be3e:ec34::2"
      when: "'freebsd-servers-dmz' not in group_names"
    - include_role:
        name: freebsd/rcconf
      vars:
        name: "ipv6_static_routes"
        value: "lan6"
      when: "'freebsd-servers-dmz' in group_names"
    - include_role:
        name: freebsd/rcconf
      vars:
        name: "ipv6_route_lan6"
        value: "-net fd3e:be3e:ec34:0:: -prefixlen 64 fd3e:be3e:ec34:1::1"
      when: "'freebsd-servers-dmz' in group_names"
    - include_role:
        name: freebsd/rcconf
      vars:
        name: "snmpd_enable"
        value: "NO"
    - include_role:
        name: freebsd/rcconf
      vars:
        name: "nrpe2_enable"
        value: "YES"
    - include_role:
        name: freebsd/rcconf
      vars:
        name: "clear_tmp_enable"
        value: "YES"
    - include_role:
        name: freebsd/rcconf
      vars:
        name: "accounting_enable"
        value: "YES"
    - include_role:
        name: freebsd/rcconf
      vars:
        name: "sshd_enable"
        value: "YES"
    - include_role:
        name: freebsd/rcconf
      vars:
        name: "gssd_enable"
        value: "YES"
    - include_role:
        name: freebsd/rcconf
      vars:
        name: "gssd_flags"
        value: "-h"
    - include_role:
        name: freebsd/rcconf
      vars:
        name: "ip6addrctl_enable"
        value: "YES"
    - include_role:
        name: freebsd/rcconf
      vars:
        name: "syslogd_flags"
        value: "-ss"
    - include_role:
        name: freebsd/rcconf
      vars:
        name: "tcp_extensions"
        value: "YES"
    - include_role:
        name: freebsd/rcconf
      vars:
        name: "sendmail_enable"
        value: "YES"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "daily_status_disks_enable"
        value: "YES"
      when: "not jail"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "daily_status_disks_df_flags"
        value: "-h"
      when: "not jail"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "daily_status_mailq_enable"
        value: "YES"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "daily_status_ntpd_enable"
        value: "YES"
      when: "not jail"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "weekly_noid_enable"
        value: "YES"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "daily_accounting_enable"
        value: "YES"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "monthly_accounting_enable"
        value: "YES"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "daily_status_security_portaudit_enable"
        value: "NO"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "daily_status_security_pkgaudit_enable"
        value: "YES"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "daily_status_include_submit_mailq"
        value: "YES"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_chkmounts_enable"
        value: "YES"
      when: "not jail"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_chkmounts_period"
        value: "daily"
      when: "not jail"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_chkuid0_enable"
        value: "YES"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_chkuid0_period"
        value: "daily"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_logincheck_enable"
        value: "YES"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_logincheck_period"
        value: "daily"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_kernelmsg_enable"
        value: "YES"
      when: "not jail"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_kernelmsg_period"
        value: "daily"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_loginfail_enable"
        value: "YES"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_loginfail_period"
        value: "daily"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_tcpwrap_enable"
        value: "YES"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_tcpwrap_period"
        value: "daily"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_chkportsum_enable"
        value: "YES"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_chkportsum_period"
        value: "daily"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_neggrpperm_enable"
        value: "YES"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_neggrpperm_period"
        value: "daily"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_passwdless_enable"
        value: "YES"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "security_status_passwdless_period"
        value: "daily"
    - include_role:
        name: freebsd/periodic
      vars:
        name: "daily_status_network_enable"
        value: "YES"
    - include_role:
        name: freebsd/sysctl
      vars:
        name: "security.bsd.see_other_uids"
        value: "0"
      when: "not jail"
    - include_role:
        name: freebsd/sysctl
      vars:
        name: "kern.randompid"
        value: "100"
      when: "not jail"
    - include_role:
        name: freebsd/aide
    - include_role:
        name: freebsd/amanda-enable
    - include_role:
        name: common/amanda-client
    - include_role:
        name: freebsd/amanda-hosts
    - include_role:
        name: common/crontab
    - include_role:
        name: freebsd/kerberos
    - include_role:
        name: freebsd/openldap-server-schemas
    - include_role:
        name: freebsd/logwatch
    - include_role:
        name: freebsd/nagios-nrpe-config
    - include_role:
        name: freebsd/sudo
    - include_role:
        name: freebsd/ntp
      when: "not jail"
    - include_role:
        name: freebsd/mailserver
    - include_role:
        name: freebsd/mailserver-smarthost
    - include_role:
        name: common/scripts
    - include_role:
        name: common/ssh-keys
    - include_role:
        name: freebsd/root-ssh-config
    - include_role:
        name: freebsd/procfs
      when: "not jail"
    - include_role:
        name: freebsd/fdescfs
      when: "not jail"
    # This role is used to make some nagios plugins work, since it
    # also links python to /usr/bin
    - include_role:
        name: freebsd/install-python
    # Keep this role here, it allows the procfs and fdescfs to succeed.
    - include_role:
        name: freebsd/set-security-level
      vars:
        enable_secure_level: True
        secure_level: "1"
      when: "not jail"
    - include_role:
        name: freebsd/edge-mailserver
      when: 'edge_mailserver'
