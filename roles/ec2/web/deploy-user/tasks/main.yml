---

- name: Create ec2-deploy user
  user:
    comment: "& user"
    create_home: yes
    group: www
    name: ec2-deploy
    password_lock: no
    password: '*'
    shell: /usr/sbin/nologin
    state: present

- name: Create ec2-deploy user authorized key
  authorized_key:
    exclusive: yes
    manage_dir: yes
    state: present
    user: ec2-deploy
    key: "{{ lookup('file', 'ec2-deploy.pub') }}"

- name: Update sshd config
  blockinfile:
    block: "{{ lookup('file', 'ec2-deploy.sshd.conf') }}"
    insertafter: EOF
    marker: '# {mark} ANSIBLE MANAGED BLOCK for ec2-deploy'
    path: /etc/ssh/sshd_config
    state: present
    validate: 'sshd -f %s -t'
  notify:
    - Restart sshd
