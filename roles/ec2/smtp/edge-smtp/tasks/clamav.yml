---

- name: Install clamav
  pkgng:
    name: clamav-milter
    state: present
  notify:
    - FreeBSD restart clamav
    - FreeBSD restart freshclam
    - FreeBSD restart clamav-milter

- name: Set MilterSocket
  lineinfile:
    path: /usr/local/etc/clamav-milter.conf
    regexp: "^MilterSocket\\s+"
    line: MilterSocket /var/run/clamav/clmilter.sock
  notify:
    - FreeBSD restart clamav-milter

- name: Set MilterSocketMode
  lineinfile:
    path: /usr/local/etc/clamav-milter.conf
    regexp: "^#?MilterSocketMode\\s+"
    line: MilterSocketMode 0660
  notify:
    - FreeBSD restart clamav-milter

- name: Set ClamdSocket
  lineinfile:
    path: /usr/local/etc/clamav-milter.conf
    regexp: "^ClamdSocket\\s+"
    line: "ClamdSocket unix:/var/run/clamav/clamd.sock"
  notify:
    - FreeBSD restart clamav-milter

- name: Set clamav-milter OnInfected Reject
  lineinfile:
    path: /usr/local/etc/clamav-milter.conf
    regexp: "^#?OnInfected\\s+"
    line: "OnInfected Reject"
  notify:
    - FreeBSD restart clamav-milter

- name: Set clamav-milter RejectMsg
  lineinfile:
    path: /usr/local/etc/clamav-milter.conf
    regexp: "^#?RejectMsg\\s+"
    line: 'RejectMsg "Mail is infected with %v"'
  notify:
    - FreeBSD restart clamav-milter

- name: Set clamav-milter AddHeader
  lineinfile:
    path: /usr/local/etc/clamav-milter.conf
    regexp: "^#?AddHeader\\s+"
    line: 'AddHeader Add'
  notify:
    - FreeBSD restart clamav-milter

- name: Set clamav-milter ReportHostname
  lineinfile:
    path: /usr/local/etc/clamav-milter.conf
    regexp: "^#?ReportHostname\\s+"
    line: 'ReportHostname smtp.guengel.ch'
  notify:
    - FreeBSD restart clamav-milter

- name: Set clamav-milter LogSyslog
  lineinfile:
    path: /usr/local/etc/clamav-milter.conf
    regexp: "^#?LogSyslog\\s+"
    line: 'LogSyslog yes'
  notify:
    - FreeBSD restart clamav-milter

- name: Set clamav-milter LogFacility
  lineinfile:
    path: /usr/local/etc/clamav-milter.conf
    regexp: "^#?LogFacility\\s+"
    line: 'LogFacility LOG_MAIL'
  notify:
    - FreeBSD restart clamav-milter

- name: Set clamav-milter LogInfected
  lineinfile:
    path: /usr/local/etc/clamav-milter.conf
    regexp: "^#?LogInfected\\s+"
    line: 'LogInfected Basic'
  notify:
    - FreeBSD restart clamav-milter

- name: Set clamav-milter LogClean
  lineinfile:
    path: /usr/local/etc/clamav-milter.conf
    regexp: "^#?LogClean\\s+"
    line: 'LogClean Basic'
  notify:
    - FreeBSD restart clamav-milter

- name: Set Clamav local socket
  lineinfile:
    path: /usr/local/etc/clamd.conf
    regexp: "^LocalSocket\\s+"
    line: "LocalSocket /var/run/clamav/clamd.sock"
  notify:
    - FreeBSD restart clamav

- name: Enable clamav services
  copy:
    src: "rc.conf.d/{{ item }}"
    dest: "/usr/local/etc/rc.conf.d/{{ item }}"
  loop:
    - clamav_clamd
    - clamav_freshclam
    - clamav_milter

- name: Initially create clam database
  command: "/usr/local/bin/freshclam"
  args:
    creates: /var/db/clamav/main.cvd

- name: Start clamav services
  service:
    name: "{{ item }}"
    state: started
  loop:
    - clamav-clamd
    - clamav-freshclam
    - clamav-milter


