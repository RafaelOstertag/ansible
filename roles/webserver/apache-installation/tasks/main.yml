---

- name: Install apache 24 to {{ jail_name }}
  pkgng:
    name: apache24
    chroot: "/var/www/jails/{{ jail_name }}"
    state: present

- name: Copy server certificate to {{ jail_name }}
  copy:
    src: "ssl/pub/{{ jail_name }}.{{ web_domain }}.crt"
    dest: "/var/www/jails/{{ jail_name }}/usr/local/etc/apache24/server.crt"
    owner: root
    group: wheel
    mode: 0644
    
- name: Copy server key to {{ jail_name }}
  copy:
    src: "ssl/priv/{{ jail_name }}.{{ web_domain }}.key"
    dest: "/var/www/jails/{{ jail_name }}/usr/local/etc/apache24/server.key"
    owner: root
    group: wheel
    mode: 0600
    decrypt: true

- name: Remove sample cgi scripts in {{ jail_name }}
  file:
    dest: "/var/www/jails/{{ jail_name }}/usr/local/www/apache24/cgi-bin/{{ file_item }}"
    state: absent
  with_items:
    - printenv
    - test-cgi
  loop_control:
    loop_var: file_item

# We include it, but the installation doesn't find it
- name: Remove mpm fallback configuration in {{ jail_name }}
  file:
    dest: "/var/www/jails/{{ jail_name }}/usr/local/etc/apache24/modules.d/000_mpm_prefork_fallback.conf"
    state: absent

- name: Enable www group to write to data directory
  file:
    state: directory
    dest: "/var/www/jails/{{ jail_name }}/usr/local/www/apache24/data"
    mode: 0775
    owner: root
    group: www
  when: "groupWriteable"
    

- name: Enable apache24 in {{ jail_name }}
  lineinfile:
    path: "/var/www/jails/{{ jail_name }}/etc/rc.conf.d/apache24"
    create: yes
    regexp: ^apache24_enable
    line: "apache24_enable=\"YES\""

- name: Enable http_accept apache24 in {{ jail_name }}
  lineinfile:
    path: "/var/www/jails/{{ jail_name }}/etc/rc.conf.d/apache24"
    create: yes
    regexp: ^apache24_http_accept
    line: "apache24_http_accept_enable=\"YES\""
